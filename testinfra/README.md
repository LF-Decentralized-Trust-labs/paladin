# Test Infrastructure

This package provides Docker-based test infrastructure for Paladin component tests, including Besu blockchain nodes and PostgreSQL databases.

## Features

- **Configurable Besu Node**: Single bootstrap tool that supports both free gas and gas-priced configurations
- **PostgreSQL Database**: Shared database instance for component tests
- **Command Line Options**: Flexible configuration via command line flags
- **Custom Account Generation**: Configurable seed and derivation paths for predictable test accounts
- **Prefunded Accounts**: Automatically prefund generated accounts in the genesis block

## Usage

### Free Gas Besu (Default)

To start the default test infrastructure with free gas:

```bash
./gradlew startTestInfra
```

This will start:
- PostgreSQL on port 5432
- Besu RPC on port 8545
- Besu WebSocket on port 8546

To stop:

```bash
./gradlew stopTestInfra
```

### Gas-Priced Besu

To start the test infrastructure with gas pricing:

```bash
./gradlew startTestInfraWithGas
```

This will start:
- PostgreSQL on port 5432
- Besu RPC on port 8547
- Besu WebSocket on port 8548
- Minimum gas price: 1 Gwei (1000000000 wei)

To stop:

```bash
./gradlew stopTestInfraWithGas
```

## Configuration

### Gas Price Configuration

The gas-priced Besu node can be configured with different minimum gas prices by modifying the `docker-compose-test-with-gas.yml` file:

```yaml
services:
  besu_gas:
    command:
      - --min-gas-price=2000000000  # 2 Gwei
```

### Genesis Configuration

The genesis configuration is generated by the bootstrap tools and includes:
- Chain ID: 1337
- QBFT consensus
- Pre-funded accounts
- Configurable gas pricing

## Cleanup

To clean up all Docker resources:

```bash
./gradlew clean
```

This will:
- Stop all running containers
- Remove all volumes
- Remove all Docker images

## Development

### Building Bootstrap Tool

The bootstrap tool is automatically built when starting the infrastructure, but can be built manually:

```bash
# Build the unified bootstrap tool
./gradlew besuBootstrapTool
```

### Custom Gas Prices

To use a different minimum gas price, modify the `docker-compose-test-with-gas.yml` file:

```yaml
services:
  besu_bootstrap_gas:
    command:
      - --min-gas-price=5000000000  # 5 Gwei
      - --zero-base-fee=false
      - /var/besu
```

### Custom Account Generation

The bootstrap tool supports custom seed and derivation paths for account generation:

```bash
# Use custom seed and derivation paths
docker run --rm -v /tmp/test:/var/besu paladin/besu_bootstrap \
  --seed="my-custom-seed-phrase" \
  --prefunded-derivation-paths="m/44'/60'/0'/0/0,m/44'/60'/0'/0/1,m/44'/60'/0'/0/2" \
  --min-gas-price=1000000000 \
  --zero-base-fee=false \
  /var/besu
```

**Command Line Options:**
- `--seed`: BIP39 seed phrase for account generation (optional, must be used with --prefunded-derivation-paths)
- `--prefunded-derivation-paths`: Comma-separated list of BIP32 derivation paths for prefunded accounts (optional, must be used with --seed)
- `--min-gas-price`: Minimum gas price in wei (default: "0" for free gas)
- `--zero-base-fee`: Enable zero base fee (default: true)

**Note:** If you want to prefund custom accounts, both `--seed` and `--prefunded-derivation-paths` must be provided together. If neither is provided, no accounts will be prefunded (only the validator account will be funded).

Then restart:

```bash
./gradlew stopTestInfraWithGas
./gradlew startTestInfraWithGas
```
