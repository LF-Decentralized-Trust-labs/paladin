# Test Infrastructure

This package provides Docker-based test infrastructure including both free gas and gas-priced Besu blockchain nodes and a shared PostgreSQL database.

## Features

- **Dual Besu Nodes**: Both free gas and gas-priced Besu nodes running simultaneously
- **Shared PostgreSQL Database**: Single database instance for all tests
- **Configurable Ports**: Different ports for each Besu type to avoid conflicts
- **Prefunded Accounts**: Gas-priced Besu includes prefunded test accounts
- **Unified Management**: Single start/stop command for all infrastructure

## Usage

### Starting the Infrastructure

To start the complete test infrastructure (both Besu nodes + PostgreSQL):

```bash
./gradlew startTestInfra
```

This will start:
- **PostgreSQL** on port 5432
- **Free Gas Besu** on ports 8545 (HTTP) and 8546 (WebSocket)
- **Gas-Priced Besu** on ports 8555 (HTTP) and 8556 (WebSocket)

To stop:

```bash
./gradlew stopTestInfra
```

## Configuration

### Port Configuration

The infrastructure uses different ports for each Besu node to avoid conflicts:

- **Free Gas Besu**: Ports 8545 (HTTP) and 8546 (WebSocket)
- **Gas-Priced Besu**: Ports 8555 (HTTP) and 8556 (WebSocket)
- **PostgreSQL**: Port 5432 (shared by both)

### Gas Price Configuration

The gas-priced Besu node is configured with a minimum gas price of 1 Gwei (1000000000 wei). To modify this, edit the `docker-compose-test.yml` file:

```yaml
services:
  besu_bootstrap_gas:
    command:
      - --min-gas-price=2000000000  # 2 Gwei
      - --zero-base-fee=false
      - --seeds=...
      - --prefunded-derivation-paths=...
      - /var/besu
```

### Genesis Configuration

The genesis configuration is generated by the bootstrap tools and includes:
- Chain ID: 1337
- QBFT consensus
- EIP-1559 support (London block at 0)
- Pre-funded accounts (gas-priced Besu only)
- Configurable gas pricing

### Prefunded Accounts

The gas-priced Besu node includes prefunded test accounts generated from three test seeds:

- **TestSeed1**: `b461057bef2aeaf43816f95b3c41b667d6fa56342f278d9237d7463226fd101d`
- **TestSeed2**: `a461057bef2aeaf43816f95b3c41b667d6fa56342f278d9237d7463226fd101e`
- **TestSeed3**: `c461057bef2aeaf43816f95b3c41b667d6fa56342f278d9237d7463226fd101f`

These accounts are derived using BIP32 paths and prefunded with 1000 ETH each.

## Cleanup

To clean up all Docker resources:

```bash
./gradlew clean
```

This will:
- Stop all running containers
- Remove all volumes
- Remove all Docker images

## Development

### Building Bootstrap Tool

The bootstrap tool is automatically built when starting the infrastructure, but can be built manually:

```bash
# Build the bootstrap tool
./gradlew besuBootstrapTool
```

### Custom Account Generation

The bootstrap tool supports custom seed and derivation paths for account generation:

```bash
# Use custom seeds and derivation paths
docker run --rm -v /tmp/test:/var/besu paladin/besu_bootstrap \
  --seeds="seed1,seed2,seed3" \
  --prefunded-derivation-paths="m/44'/60'/0'/0/0,m/44'/60'/0'/0/1,m/44'/60'/0'/0/2" \
  --min-gas-price=1000000000 \
  --zero-base-fee=false \
  /var/besu
```

**Command Line Options:**
- `--seeds`: Comma-separated list of hex-encoded seeds for account generation (optional, must be used with --prefunded-derivation-paths)
- `--prefunded-derivation-paths`: Comma-separated list of BIP32 derivation paths for prefunded accounts (optional, must be used with --seeds)
- `--min-gas-price`: Minimum gas price in wei (default: "0" for free gas)
- `--zero-base-fee`: Enable zero base fee (default: true)

**Note:** If you want to prefund custom accounts, both `--seeds` and `--prefunded-derivation-paths` must be provided together. If neither is provided, no accounts will be prefunded (only the validator account will be funded).

### Testing Different Configurations

To test with different configurations, modify the `docker-compose-test.yml` file and restart:

```bash
./gradlew stopTestInfra
./gradlew startTestInfra
```
